<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of onPushRun</title>
  <meta name="keywords" content="onPushRun">
  <meta name="description" content=" starts the calculation">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # blochus --><!-- # callbacks --><!-- menu.html push -->
<h1>onPushRun
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong> starts the calculation</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function onPushRun(src,~) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">onPushRun starts the calculation

 Syntax:
       onPushRun(src)

 Inputs:
       src - handle of the calling object

 Outputs:
       none

 Example:
       onPushRun(src)

 Other m-files required:
       fcn_BLOCHUS_ode
       getFFT
       getMrot
       getOmega0
       getPulsePhase
       getPulseTimeSeries
       plotResults

 Subfunctions:
       none

 MAT-files required:
       none

 See also: BLOCHUS
 Author: Thomas Hiller
 email: thomas.hiller[at]leibniz-liag.de
 License: GNU GPLv3 (at end)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>	 is the objective function for the ode-solver which solves</li><li><a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>	 calculates the FFT for a given time and signal pair</li><li><a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>	 transforms the magnetization from the laboratory frame of</li><li><a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>	 calculates the angular frequency from a given B-field and</li><li><a href="../../../blochus/functions/blochsim/getPulsePhase.html" class="code" title="function theta = getPulsePhase(t,df,param,flag)">getPulsePhase</a>	 provides the instantaneous phase of a pulse; this is</li><li><a href="../../../blochus/functions/blochsim/getPulseTimeSeries.html" class="code" title="function [Bout,df,I,theta] = getPulseTimeSeries(param)">getPulseTimeSeries</a>	 returns the B-field amplitudes of the pulse either for a</li><li><a href="../../../blochus/functions/interface/plotResults.html" class="code" title="function plotResults(fig)">plotResults</a>	 plots results depending on the chosen settings</li><li><a href="../../../blochus/functions/interface/updateStatusInformation.html" class="code" title="function updateStatusInformation(fig)">updateStatusInformation</a>	 updates all fields inside the bottom status bar</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../blochus/BLOCHUS/BLOCHUS_createPanelControl.html" class="code" title="function [gui,myui] = BLOCHUS_createPanelControl(gui,myui)">BLOCHUS_createPanelControl</a>	 creates "Control" panel</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function onPushRun(src,~)</a>
0002 <span class="comment">%onPushRun starts the calculation</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax:</span>
0005 <span class="comment">%       onPushRun(src)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%       src - handle of the calling object</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Outputs:</span>
0011 <span class="comment">%       none</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Example:</span>
0014 <span class="comment">%       onPushRun(src)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Other m-files required:</span>
0017 <span class="comment">%       fcn_BLOCHUS_ode</span>
0018 <span class="comment">%       getFFT</span>
0019 <span class="comment">%       getMrot</span>
0020 <span class="comment">%       getOmega0</span>
0021 <span class="comment">%       getPulsePhase</span>
0022 <span class="comment">%       getPulseTimeSeries</span>
0023 <span class="comment">%       plotResults</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% Subfunctions:</span>
0026 <span class="comment">%       none</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% MAT-files required:</span>
0029 <span class="comment">%       none</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% See also: BLOCHUS</span>
0032 <span class="comment">% Author: Thomas Hiller</span>
0033 <span class="comment">% email: thomas.hiller[at]leibniz-liag.de</span>
0034 <span class="comment">% License: GNU GPLv3 (at end)</span>
0035 
0036 <span class="comment">%------------- BEGIN CODE --------------</span>
0037 
0038 <span class="comment">% get GUI handle</span>
0039 fig = ancestor(src,<span class="string">'figure'</span>,<span class="string">'toplevel'</span>);
0040 
0041 <span class="keyword">if</span> ~isempty(fig) &amp;&amp; strcmp(get(fig,<span class="string">'Tag'</span>),<span class="string">'BLOCHUS'</span>)
0042     <span class="comment">% get GUI data</span>
0043     gui = getappdata(fig,<span class="string">'gui'</span>);
0044     data = getappdata(fig,<span class="string">'data'</span>);
0045     
0046     <span class="comment">% change the pushbutton color to indicate that a calculation is running</span>
0047     set(src,<span class="string">'BackGroundColor'</span>,<span class="string">'r'</span>);
0048     <span class="comment">% reset the color of the animate button</span>
0049     set(gui.push_handles.Animate,<span class="string">'BackGroundColor'</span>,[.94 .94 .94]);
0050     
0051     <span class="comment">% basic parameter that are always needed</span>
0052     <span class="comment">% z unit vector</span>
0053     zunit = [0 0 1]';
0054     <span class="comment">% initial magnetization [A/m]</span>
0055     Minit = data.basic.Minit(:);
0056     <span class="comment">% total simulation time Tsim [s]</span>
0057     Tsim = data.basic.Tsim/1e3; 
0058     
0059     <span class="comment">% parameter needed for the ODE solver</span>
0060     <span class="comment">% simulation type [string]</span>
0061     odeparam.type = data.basic.type;
0062     <span class="comment">% equilibrium magnetization [A/m]</span>
0063     odeparam.M0 = data.basic.M0(:);
0064     <span class="comment">% primary (Earth's) magnetic field B0 [T]</span>
0065     odeparam.B0 = data.basic.B0;
0066     <span class="comment">% longitudinal relaxation time T1 [s]</span>
0067     odeparam.T1 = data.basic.T1relax/1e3;
0068     <span class="comment">% transversal relaxation time T2 [s]</span>
0069     odeparam.T2 = data.basic.T2relax/1e3;
0070     <span class="comment">% gyromagnetic ratio [rad/s/T]</span>
0071     odeparam.gamma = data.basic.gamma; 
0072     
0073     <span class="comment">% ODE solver error tolerance</span>
0074     tol = 1e-9;
0075     <span class="comment">% ODE solver options</span>
0076     options = odeset(<span class="string">'RelTol'</span>,tol,<span class="string">'AbsTol'</span>,[tol tol tol]);
0077     
0078     <span class="comment">% time the calculation</span>
0079     t0 = tic;
0080     <span class="keyword">switch</span> data.basic.type
0081         <span class="keyword">case</span> <span class="string">'std'</span>
0082             <span class="comment">% update Info field</span>
0083             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of relaxation ...'</span>);
0084             pause(0.01);
0085             
0086             <span class="comment">% normalized initial magnetization</span>
0087             Minit = Minit./norm(Minit);
0088             <span class="comment">% update the corresponding GUI fields</span>
0089             data.basic.Minit = Minit;
0090             set(gui.edit_handles.Minitx,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(1)));
0091             set(gui.edit_handles.Minity,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(2)));
0092             set(gui.edit_handles.Minitz,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(3)));
0093             
0094             <span class="comment">% ODE solver call</span>
0095             <span class="comment">% OUTPUT: time T and magnetization M</span>
0096             [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Tsim],Minit,options);
0097             
0098             <span class="comment">% save data</span>
0099             data.results.basic.T = TT;
0100             data.results.basic.M = MM;
0101             
0102             <span class="comment">% rotate M into rotating frame of reference</span>
0103             Mrot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,<a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0).*TT);
0104             data.results.basic.Mrot = Mrot;
0105             
0106             <span class="comment">% get FFTof M in the laboratory frame of reference</span>
0107             [Xm,fx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,MM(:,1:2));
0108             data.results.basic.Mspec.fx = fx;
0109             data.results.basic.Mspec.X = Xm;
0110             
0111             <span class="comment">% update Info field</span>
0112             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of relaxation ... finished.'</span>);
0113             pause(0.01);
0114             
0115         <span class="keyword">case</span> <span class="string">'prepol'</span>
0116             <span class="comment">% update Info field</span>
0117             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of pre-polarization switch-off ...'</span>);
0118             pause(0.01);
0119             
0120             <span class="comment">% initial magnetization in the direction of B0+Bp</span>
0121             Morient = data.results.prepol.orient*data.results.prepol.Bmax + odeparam.B0*zunit;
0122             <span class="comment">% Minit does not get normalized in this case</span>
0123             Minit = Morient;<span class="comment">%./norm(Morient);</span>
0124             <span class="comment">% because Minit is not normalized to 1, M0 needs to be adjusted</span>
0125             odeparam.M0 = odeparam.B0*zunit;
0126             <span class="comment">% update the corresponding GUI fields</span>
0127             set(gui.edit_handles.Minitx,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(1)/norm(Minit)));
0128             set(gui.edit_handles.Minity,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(2)/norm(Minit)));
0129             set(gui.edit_handles.Minitz,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(3)/norm(Minit)));
0130             
0131             <span class="comment">% orientation of the pre-polarization pulse axis</span>
0132             odeparam.orient = data.results.prepol.orient;
0133             
0134             <span class="comment">% pre-polarization switch-off ramp parameter</span>
0135             <span class="comment">% relaxation during switch-off [0/1]</span>
0136             odeparam.RDS = data.prepol.RDS;
0137             <span class="comment">% switch-off ramp type [string]</span>
0138             rampparam.ramp = data.prepol.Ramp;            
0139             <span class="comment">% amplitude of pre-polarization field</span>
0140             rampparam.Bmax = data.results.prepol.Bmax;
0141             <span class="comment">% switch over magnetization (for linexp case)</span>
0142             rampparam.Bstar = data.results.prepol.Bstar;
0143             <span class="comment">% switch-off ramp time [s]</span>
0144             rampparam.Tramp = data.prepol.Tramp/1e3;
0145             <span class="comment">% switch over ramp time [s] (for linexp case)</span>
0146             rampparam.Tslope = data.prepol.Tslope/1e3;
0147             
0148             <span class="comment">% add the ramp parameter to the ode parameter struct</span>
0149             odeparam.rampparam = rampparam;
0150             
0151             <span class="comment">% ODE solver call</span>
0152             <span class="comment">% OUTPUT: time T and magnetization M</span>
0153             [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Tsim],Minit,options);
0154             
0155             <span class="comment">% normalized magnetization vector at end of switch-off ramp</span>
0156             <span class="comment">% because the simulation can be longer than the ramp, find the</span>
0157             <span class="comment">% last point of the ramp to calculate the adiabatic quality p</span>
0158             indt = find(TT&lt;=rampparam.Tramp,1,<span class="string">'last'</span>);
0159             MMn = MM(indt,:)./norm(MM(indt,:));
0160             <span class="comment">% &quot;adiabatic quality&quot; p of the switch-off ramp</span>
0161             <span class="comment">% -&gt; orientation of M with respect to z_unit</span>
0162             p = dot(MMn,zunit)./norm(zunit);
0163             
0164             <span class="comment">% save data</span>
0165             data.results.basic.T = TT;
0166             data.results.basic.M = MM;
0167             data.results.prepol.p = p;
0168             
0169             <span class="comment">% update Info field</span>
0170             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of pre-polarization switch-off ... finished.'</span>);
0171             pause(0.01);
0172             
0173             <span class="comment">% activate the lab-frame panels to show the results</span>
0174             set(gui.panels.Plot.Mag,<span class="string">'Selection'</span>,1);
0175             set(gui.panels.Plot.Sphere,<span class="string">'Selection'</span>,1);
0176             
0177         <span class="keyword">case</span> <span class="string">'pulse'</span>
0178             <span class="comment">% update Info field</span>
0179             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of excitation pulse ...'</span>);
0180             pause(0.01);
0181             
0182             <span class="comment">% normalized initial magnetization</span>
0183             Minit = Minit./norm(Minit);
0184             <span class="comment">% update the corresponding GUI fields</span>
0185             data.basic.Minit = Minit;
0186             set(gui.edit_handles.Minitx,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(1)));
0187             set(gui.edit_handles.Minity,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(2)));
0188             set(gui.edit_handles.Minitz,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(3)));
0189             
0190             <span class="comment">% excitation pulse parameter</span>
0191             <span class="comment">% relaxation during pulse [0/1]</span>
0192             odeparam.RDP = data.pulse.RDP;
0193             <span class="comment">% pulse length [s]</span>
0194             odeparam.Ttau = data.pulse.Ttau/1e3;
0195             <span class="comment">% pulse type [string]</span>
0196             pulseparam.PulseType = data.pulse.Type;
0197             <span class="comment">% gyromagnetic ratio [rad/s/T]</span>
0198             pulseparam.gamma = odeparam.gamma;
0199             <span class="comment">% Larmor frequency [rad/s]</span>
0200             pulseparam.omega0 = <a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0);
0201             <span class="comment">% pulse amplitude [T]</span>
0202             pulseparam.Amp = odeparam.B0*data.pulse.B1Factor;
0203             <span class="comment">% pulse frequency modulation [struct]</span>
0204             pulseparam.fmod = data.results.pulse.fmod;
0205             <span class="comment">% pulse current modulation [struct]</span>
0206             pulseparam.Imod = data.results.pulse.Imod;
0207             <span class="comment">% auxiliary pulse phase [rad]</span>
0208             pulseparam.phi = 0;
0209             <span class="comment">% pulse axis [string]</span>
0210             pulseparam.PulseAxis = data.pulse.Axis;
0211             <span class="comment">% pulse polarization [string]</span>
0212             pulseparam.PulsePolarization = data.pulse.Polarization;
0213             <span class="comment">% if the discrete MIDI pulses are used add the corresponding</span>
0214             <span class="comment">% data</span>
0215             <span class="keyword">if</span> isfield(data,<span class="string">'pulse_MIDI'</span>)
0216                 <span class="comment">% MIDI pulse data [struct]</span>
0217                 pulseparam.MIDI = data.pulse_MIDI;
0218             <span class="keyword">end</span>
0219             
0220             <span class="comment">% add the pulse parameter to the ode parameter struct</span>
0221             odeparam.pulseparam = pulseparam;
0222             
0223             <span class="comment">% ODE solver call</span>
0224             <span class="comment">% OUTPUT: time T and magnetization M</span>
0225             <span class="keyword">switch</span> data.pulse.Type
0226                 <span class="keyword">case</span> {<span class="string">'MIDI_OR'</span>,<span class="string">'MIDI_AP'</span>}
0227                     <span class="comment">% if Tsim &gt; Ttau extend the discrete time steps</span>
0228                     <span class="comment">% this is needed because for the discrete pulses</span>
0229                     <span class="comment">% specific time steps are fed into the solver</span>
0230                     Tsim = unique([data.pulse_MIDI.t;(0:1/50e3:Tsim)']);
0231                     [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),Tsim,Minit,options);
0232                 <span class="keyword">otherwise</span>
0233                     [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Tsim],Minit,options);
0234             <span class="keyword">end</span>
0235             
0236             <span class="comment">% save data</span>
0237             data.results.basic.T = TT;
0238             data.results.basic.M = MM;
0239             
0240             <span class="comment">% in order to transform M in the rotating frame of reference</span>
0241             <span class="comment">% get the pulse phase theta for all simulated time steps</span>
0242             pulseparam.fmod.t = TT;
0243             pulseparam.Imod.t = TT;
0244             pulseparam.t = TT;
0245             <span class="comment">% get also the pulse amplitudes at these time steps</span>
0246             [Bpulse,~,~,theta] = <a href="../../../blochus/functions/blochsim/getPulseTimeSeries.html" class="code" title="function [Bout,df,I,theta] = getPulseTimeSeries(param)">getPulseTimeSeries</a>(pulseparam);
0247             
0248             <span class="comment">% if the simulation is longer then the pulse (additional</span>
0249             <span class="comment">% relaxation afterwards), correct for the pulse phase for</span>
0250             <span class="comment">% points AFTER the pulse by simply calculating the phase at</span>
0251             <span class="comment">% the end of the pulse</span>
0252             <span class="keyword">if</span> data.basic.Tsim&gt;data.pulse.Ttau
0253                 <span class="comment">% correction phase</span>
0254                 dphi = zeros(size(theta));
0255                 <span class="comment">% pulse length</span>
0256                 Ttau = odeparam.Ttau;
0257                 <span class="comment">% get pulse phase at the end of the pulse</span>
0258                 dphival = <a href="../../../blochus/functions/blochsim/getPulsePhase.html" class="code" title="function theta = getPulsePhase(t,df,param,flag)">getPulsePhase</a>(Ttau,0,pulseparam,1);
0259                 <span class="comment">% and add it to the correction phase for all time steps after</span>
0260                 <span class="comment">% the pulse</span>
0261                 indT = TT&gt;Ttau;
0262                 dphi(indT) = dphival;
0263                 <span class="comment">% set theta for all time steps after the pulse simply to</span>
0264                 <span class="comment">% omega0*t</span>
0265                 theta(indT) = <a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0).*TT(indT);
0266                 <span class="comment">% get M(T) in rotating frame of reference</span>
0267                 Mrot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,theta,dphi);
0268                 <span class="comment">% get FFT of M in the laboratory frame of reference</span>
0269                 [Xm,fmx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,MM(:,1:2));
0270                 <span class="comment">% get FFT of the pulse</span>
0271                 [Xb,fbx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT(TT&lt;=Ttau),Bpulse(TT&lt;=Ttau,1:2));
0272                 
0273                 <span class="comment">% update Info field</span>
0274                 set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of excitation pulse &amp; relaxation ... finished.'</span>);
0275                 pause(0.01);
0276             <span class="keyword">else</span>
0277                 <span class="comment">% get M(T) in rotating frame of reference</span>
0278                 Mrot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,theta);
0279                 <span class="comment">% get FFT of M in the laboratory frame of reference</span>
0280                 [Xm,fmx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,MM(:,1:2));
0281                 <span class="comment">% get FFT of the pulse</span>
0282                 [Xb,fbx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,Bpulse(:,1:2));
0283                 
0284                 <span class="comment">% update Info field</span>
0285                 set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of excitation pulse ... finished.'</span>);
0286                 pause(0.01);
0287             <span class="keyword">end</span>
0288             
0289             <span class="comment">% save data</span>
0290             data.results.basic.Mrot = Mrot;
0291             data.results.basic.Mspec.fx = fmx;
0292             data.results.basic.Mspec.X = Xm;
0293             data.results.pulse.Bspec.fx = fbx;
0294             data.results.pulse.Bspec.X = Xb;
0295             
0296         <span class="keyword">case</span> <span class="string">'prepolpulse'</span>
0297             
0298             <span class="comment">% this is basically the combination of all of the above</span>
0299             <span class="comment">% simulation types</span>
0300             <span class="comment">%  --- IMPORTANT NOTE: ----------------------------------------</span>
0301             <span class="comment">% The pre-polarization switch-off only &quot;lives&quot; in the laboratory</span>
0302             <span class="comment">% frame of reference. However, for convenience reasons I plot</span>
0303             <span class="comment">% the lab-frame pre-polarization data also in the rotating</span>
0304             <span class="comment">% frame of reference! This is u-n-p-h-y-s-i-c-a-l and pure &quot;eye candy&quot;</span>
0305             <span class="comment">%  -------------------------------------------------------------</span>
0306             
0307             <span class="comment">% these times we will later on, so init them already here</span>
0308             <span class="comment">% total simulation time [s]</span>
0309             Tsim = data.basic.Tsim/1e3;
0310             <span class="comment">% switch-off ramp time [s]</span>
0311             Tramp = data.prepol.Tramp/1e3;
0312             <span class="comment">% wait time between switch-off ramp and pulse [s]</span>
0313             Twait = data.pulse.Twait/1e3;
0314             <span class="comment">% pulse length [s]</span>
0315             Ttau = data.pulse.Ttau/1e3;
0316             
0317             <span class="comment">% check if the simulation time is long enough to process all</span>
0318             <span class="comment">% different stages, if not fix it</span>
0319             <span class="comment">% NOTE: of course the simulation time can be longer (relaxation)</span>
0320             <span class="comment">% after the pulse</span>
0321             <span class="keyword">if</span> Tsim-(Tramp+Twait+Ttau) &lt; 0
0322                 Tsim = Tramp+Twait+Ttau;
0323                 <span class="comment">% update the corresponding GUI data and field</span>
0324                 data.basic.Tsim = Tsim*1e3; <span class="comment">% [ms]</span>
0325                 set(gui.edit_handles.Tsim,<span class="string">'String'</span>,num2str(data.basic.Tsim));
0326                 <span class="comment">% no relaxation after excitation pulse</span>
0327                 Trelax = 0;
0328             <span class="keyword">else</span>
0329                 <span class="comment">% relaxation after excitation pulse [s]</span>
0330                 Trelax = Tsim-(Tramp+Twait+Ttau);
0331             <span class="keyword">end</span>
0332             
0333             <span class="comment">% -------------------------------------------------------------</span>
0334             <span class="comment">%% --- 1.) pre-polarization switch-off ------------------------</span>
0335             <span class="comment">% -------------------------------------------------------------</span>
0336             <span class="comment">% update Info field</span>
0337             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of pre-polarization switch-off ...'</span>);
0338             pause(0.01);
0339             
0340             <span class="comment">% initial magnetization in the direction of B0+Bp</span>
0341             Morient = data.results.prepol.orient*data.results.prepol.Bmax + odeparam.B0*zunit;
0342              <span class="comment">% Minit does not get normalized in this case</span>
0343             Minit = Morient;<span class="comment">%./norm(Morient);</span>
0344             <span class="comment">% because Minit is not normalized to 1, M0 needs to be adjusted</span>
0345             odeparam.M0 = odeparam.B0*zunit;
0346             <span class="comment">% update the corresponding GUI fields</span>
0347             set(gui.edit_handles.Minitx,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(1)/norm(Minit)));
0348             set(gui.edit_handles.Minity,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(2)/norm(Minit)));
0349             set(gui.edit_handles.Minitz,<span class="string">'String'</span>,sprintf(<span class="string">'%4.3f'</span>,Minit(3)/norm(Minit)));
0350 
0351             <span class="comment">% update the simulation type</span>
0352             odeparam.type = <span class="string">'prepol'</span>;
0353             
0354             <span class="comment">% orientation of the pre-polarization pulse axis</span>
0355             odeparam.orient = data.results.prepol.orient;
0356             
0357             <span class="comment">% pre-polarization switch-off ramp parameter</span>
0358             <span class="comment">% relaxation during switch-off [0/1]</span>
0359             odeparam.RDS = data.prepol.RDS;
0360             <span class="comment">% switch-off ramp type [string]</span>
0361             rampparam.ramp = data.prepol.Ramp;            
0362             <span class="comment">% amplitude of pre-polarization field</span>
0363             rampparam.Bmax = data.results.prepol.Bmax;
0364             <span class="comment">% switch over magnetization (for linexp case)</span>
0365             rampparam.Bstar = data.results.prepol.Bstar;
0366             <span class="comment">% switch-off ramp time [s]</span>
0367             rampparam.Tramp = Tramp;
0368             <span class="comment">% switch over ramp time [s] (for linexp case)</span>
0369             rampparam.Tslope = data.prepol.Tslope/1e3;
0370             
0371             <span class="comment">% add the ramp parameter to the ode parameter struct</span>
0372             odeparam.rampparam = rampparam;
0373             
0374             <span class="comment">% ODE solver call</span>
0375             <span class="comment">% OUTPUT: time T and magnetization M</span>
0376             [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Tramp],Minit,options);
0377             
0378             <span class="comment">% data of the first stage</span>
0379             TT1 = TT;
0380             MM1 = MM;
0381 
0382             <span class="comment">% normalized magnetization vector at end of switch-off ramp</span>
0383             MMn = MM(<span class="keyword">end</span>,:)./norm(MM(<span class="keyword">end</span>,:));
0384             <span class="comment">% &quot;adiabatic quality&quot; p of the switch-off ramp</span>
0385             <span class="comment">% -&gt; orientation of M with respect to z_unit</span>
0386             data.results.prepol.p = dot(MMn(<span class="keyword">end</span>,:),zunit)./norm(zunit);
0387             
0388             <span class="comment">% -------------------------------------------------------------</span>
0389             <span class="comment">%% --- 2.) wait time (if any) ---------------------------------</span>
0390             <span class="comment">% -------------------------------------------------------------</span>
0391             <span class="keyword">if</span> Twait &gt; 0
0392                 <span class="comment">% update Info field</span>
0393                 set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of wait time ...'</span>);
0394                 pause(0.01);
0395                 <span class="comment">% initial magnetization is the end of the switch-off ramp</span>
0396                 Minit2 = MM1(<span class="keyword">end</span>,:)';
0397                 <span class="comment">% update the simulation type</span>
0398                 odeparam.type = <span class="string">'std'</span>;
0399                 
0400                 <span class="comment">% ODE solver call</span>
0401                 <span class="comment">% OUTPUT: time T and magnetization M</span>
0402                 [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Twait],Minit2,options);
0403                 
0404                 <span class="comment">% rotate M into rotating frame of reference</span>
0405                 MM2rot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,<a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0).*TT);
0406                 <span class="comment">% get the additional phase at the end of the wait time</span>
0407                 phiWait = <a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0).*TT(end);
0408                 
0409                 <span class="comment">% because the simulation was done in &quot;local&quot; time</span>
0410                 <span class="comment">% coordinates, shift the time vector to the end of the</span>
0411                 <span class="comment">% switch-off ramp</span>
0412                 TT2 = TT + Tramp;
0413                 <span class="comment">% save data</span>
0414                 MM2 = MM;
0415                 <span class="comment">% initial magnetization for the pulse is the end of the</span>
0416                 <span class="comment">% wait time period</span>
0417                 Minit3 = MM2(<span class="keyword">end</span>,:)';
0418             <span class="keyword">else</span>
0419                 <span class="comment">% if wait time is 0, use dummy values</span>
0420                 TT2 = [];
0421                 MM2 = [];
0422                 MM2rot = [];
0423                 phiWait = 0;
0424                 <span class="comment">% initial magnetization for the pulse is the end of the</span>
0425                 <span class="comment">% switch-off ramp</span>
0426                 Minit3 = MM1(<span class="keyword">end</span>,:)';
0427             <span class="keyword">end</span>
0428             
0429             <span class="comment">% -------------------------------------------------------------</span>
0430             <span class="comment">%% --- 3.) excitation pulse -----------------------------------</span>
0431             <span class="comment">% -------------------------------------------------------------</span>
0432             
0433             <span class="comment">% update the simulation type</span>
0434             odeparam.type = <span class="string">'pulse'</span>;
0435 
0436             <span class="comment">% excitation pulse parameter</span>
0437             <span class="comment">% relaxation during pulse [0/1]</span>
0438             odeparam.RDP = data.pulse.RDP;
0439             <span class="comment">% pulse length [s]</span>
0440             odeparam.Ttau = Ttau;
0441             
0442             <span class="comment">% pulse type [string]</span>
0443             pulseparam.PulseType = data.pulse.Type;
0444             <span class="comment">% gyromagnetic ratio [rad/s/T]</span>
0445             pulseparam.gamma = odeparam.gamma;
0446             <span class="comment">% Larmor frequency [rad]</span>
0447             pulseparam.omega0 = <a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0);
0448             <span class="comment">% pulse amplitude [B0]</span>
0449             pulseparam.Amp = odeparam.B0*data.pulse.B1Factor;
0450             <span class="comment">% pulse frequency modulation [struct]</span>
0451             pulseparam.fmod = data.results.pulse.fmod;
0452             <span class="comment">% pulse current modulation [struct]</span>
0453             pulseparam.Imod = data.results.pulse.Imod;
0454             <span class="comment">% auxiliary pulse phase [rad]</span>
0455             pulseparam.phi = 0;
0456             <span class="comment">% pulse axis [string]</span>
0457             pulseparam.PulseAxis = data.pulse.Axis;
0458             <span class="comment">% pulse polarization [string]</span>
0459             pulseparam.PulsePolarization = data.pulse.Polarization;
0460             <span class="comment">% if the discrete MIDI pulses are used add the corresponding</span>
0461             <span class="comment">% data</span>
0462             <span class="keyword">if</span> isfield(data,<span class="string">'pulse_MIDI'</span>)
0463                 <span class="comment">% MIDI pulse data [struct]</span>
0464                 pulseparam.MIDI = data.pulse_MIDI;
0465             <span class="keyword">end</span>
0466 
0467             <span class="comment">% add the pulse parameter to the ode parameter struct</span>
0468             odeparam.pulseparam = pulseparam;
0469             
0470             <span class="comment">% update Info field</span>
0471             set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of excitation pulse ...'</span>);
0472             pause(0.01);
0473             
0474             <span class="comment">% if there is a time span after the pulse</span>
0475             <span class="keyword">if</span> abs(Trelax) &gt; eps
0476                 <span class="comment">% the &quot;local&quot; simulation time is prolonged</span>
0477                 Tsim1 = Ttau+Trelax;
0478             <span class="keyword">else</span>
0479                 <span class="comment">% otherwise the &quot;local&quot; simulation time is simply the pulse</span>
0480                 <span class="comment">% length</span>
0481                 Tsim1 = Ttau;
0482             <span class="keyword">end</span>
0483             
0484             <span class="comment">% ODE solver call</span>
0485             <span class="comment">% OUTPUT: time T and magnetization M</span>
0486             <span class="keyword">switch</span> data.pulse.Type
0487                 <span class="keyword">case</span> {<span class="string">'MIDI_OR'</span>,<span class="string">'MIDI_AP'</span>}
0488                     <span class="comment">% if Tsim1 &gt; Ttau extend the discrete time steps</span>
0489                     <span class="comment">% this is needed because for the discrete pulses</span>
0490                     <span class="comment">% specific time steps are fed into the solver</span>
0491                     Tsim1 = unique([data.pulse_MIDI.t;(0:1/50e3:Tsim1)']);
0492                     [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),Tsim1,Minit3,options);
0493                 <span class="keyword">otherwise</span>
0494                     [TT,MM] = ode45(@(t,m) <a href="../../../blochus/functions/blochsim/fcn_BLOCHUS_ode.html" class="code" title="function dM = fcn_BLOCHUS_ode(t,m,param)">fcn_BLOCHUS_ode</a>(t,m,odeparam),[0 Tsim1],Minit3,options);
0495             <span class="keyword">end</span>
0496             
0497             <span class="comment">% in order to transform M in the rotating frame of reference</span>
0498             <span class="comment">% get the pulse phase theta for all simulated time steps</span>
0499             pulseparam.fmod.t = TT;
0500             pulseparam.Imod.t = TT;
0501             pulseparam.t = TT;
0502             <span class="comment">% get also the pulse amplitudes at these time steps</span>
0503             [Bpulse,~,~,theta] = <a href="../../../blochus/functions/blochsim/getPulseTimeSeries.html" class="code" title="function [Bout,df,I,theta] = getPulseTimeSeries(param)">getPulseTimeSeries</a>(pulseparam);
0504             
0505             <span class="comment">% if the simulation is longer then the pulse (additional</span>
0506             <span class="comment">% relaxation afterwards), correct for the pulse phase for</span>
0507             <span class="comment">% points AFTER the pulse by simply calculating the phase at</span>
0508             <span class="comment">% the end of the pulse</span>
0509             <span class="keyword">if</span> abs(Trelax) &gt; eps<span class="comment">%max(Tsim1)&gt;Ttau</span>
0510                 <span class="comment">% correction phase</span>
0511                 dphi = zeros(size(theta));
0512                 <span class="comment">% get pulse phase at the end of the pulse</span>
0513                 dphival = <a href="../../../blochus/functions/blochsim/getPulsePhase.html" class="code" title="function theta = getPulsePhase(t,df,param,flag)">getPulsePhase</a>(Ttau,0,pulseparam,1);
0514                 <span class="comment">% and add it to the correction phase for all time steps after</span>
0515                 <span class="comment">% the pulse</span>
0516                 indT = TT&gt;Ttau;
0517                 dphi(indT) = dphival;
0518                 <span class="comment">% set theta for all time steps after the pulse simply to</span>
0519                 <span class="comment">% omega0*t</span>
0520                 theta(indT) = <a href="../../../blochus/functions/blochsim/getOmega0.html" class="code" title="function omega0 = getOmega0(gamma,B)">getOmega0</a>(odeparam.gamma,odeparam.B0).*TT(indT);
0521                 <span class="comment">% get M(T) in rotating frame of reference and account for</span>
0522                 <span class="comment">% the phase from the wait time before the pulse</span>
0523                 MM3rot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,theta,dphi+phiWait);
0524                 <span class="comment">% get FFT of the pulse</span>
0525                 [Xb,fbx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT(TT&lt;=Ttau),Bpulse(TT&lt;=Ttau,1:2));
0526                 
0527                 <span class="comment">% update Info field</span>
0528                 set(gui.text_handles.Status,<span class="string">'String'</span>,[<span class="string">'Calculation of excitation pulse'</span>,<span class="keyword">...</span>
0529                     <span class="string">' &amp; relaxation ... finished.'</span>]);
0530                 pause(0.01);
0531             <span class="keyword">else</span>
0532                 <span class="comment">% get M(T) in rotating frame of reference and account for</span>
0533                 <span class="comment">% the phase from the wait time before the pulse</span>
0534                 MM3rot = <a href="../../../blochus/functions/blochsim/getMrot.html" class="code" title="function Mrot = getMrot(M,theta,varargin)">getMrot</a>(MM,theta,phiWait);
0535                 <span class="comment">% get FFT of the pulse</span>
0536                 [Xb,fbx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,Bpulse(:,1:2));
0537                 
0538                 <span class="comment">% update Info field</span>
0539                 set(gui.text_handles.Status,<span class="string">'String'</span>,<span class="string">'Calculation of excitation pulse ... finished.'</span>);
0540                 pause(0.01);
0541             <span class="keyword">end</span>
0542             
0543             <span class="comment">% -------------------------------------------------------------</span>
0544             <span class="comment">%% --- 4.) final data merging ---------------------------------</span>
0545             <span class="comment">% -------------------------------------------------------------</span>
0546             <span class="comment">% because the simulation was done in &quot;local&quot; time</span>
0547             <span class="comment">% coordinates, shift the time vector to the end of the</span>
0548             <span class="comment">% wait time after the switch-off</span>
0549             TT3 = TT + Tramp + Twait;
0550             <span class="comment">% save data</span>
0551             MM3 = MM;
0552             
0553             <span class="comment">% combine data from all stages</span>
0554             TT = [TT1;TT2;TT3];
0555             MM = [MM1;MM2;MM3];
0556             
0557             <span class="comment">% because there is no M in the rotating frame of reference</span>
0558             <span class="comment">% during the switch-off ramp, use the lab-frame data instead</span>
0559             <span class="comment">%  --- IMPORTANT NOTE: ----------------------------------------</span>
0560             <span class="comment">% The pre-polarization switch-off only &quot;lives&quot; in the laboratory</span>
0561             <span class="comment">% frame of reference. However, for convenience reasons I plot</span>
0562             <span class="comment">% the lab-frame pre-polarization data also in the rotating</span>
0563             <span class="comment">% frame of reference! This is u-n-p-h-y-s-i-c-a-l and pure</span>
0564             <span class="comment">% &quot;eye candy&quot;</span>
0565             <span class="comment">%</span>
0566             <span class="comment">% MM1 is lab-frame data!</span>
0567             <span class="comment">%  -------------------------------------------------------------</span>
0568             MMrot = [MM1;MM2rot;MM3rot];
0569             
0570             <span class="comment">% remove possible duplicate points</span>
0571             [TT,ix] = unique(TT);
0572             MM = MM(ix,:);
0573             MMrot = MMrot(ix,:);
0574             
0575             <span class="comment">% save combined data</span>
0576             data.results.basic.T = TT;
0577             data.results.basic.M = MM;
0578             data.results.basic.Mrot = MMrot;
0579             
0580             <span class="comment">% get FFT for the combined M</span>
0581             [Xm,fmx] = <a href="../../../blochus/functions/blochsim/getFFT.html" class="code" title="function [Y,f] = getFFT(t,s)">getFFT</a>(TT,MM(:,1:2));
0582             data.results.basic.Mspec.fx = fmx;
0583             data.results.basic.Mspec.X = Xm;
0584             <span class="comment">% save pulse FFT</span>
0585             data.results.pulse.Bspec.fx = fbx;
0586             data.results.pulse.Bspec.X = Xb;
0587 
0588     <span class="keyword">end</span>
0589     <span class="comment">% time the calculation</span>
0590     data.info.Timer = toc(t0);
0591     
0592     <span class="comment">% update GUI data</span>
0593     setappdata(fig,<span class="string">'data'</span>,data);
0594     <span class="comment">% plot results</span>
0595     <a href="../../../blochus/functions/interface/plotResults.html" class="code" title="function plotResults(fig)">plotResults</a>(fig);
0596     <span class="comment">% update status bar</span>
0597     <a href="../../../blochus/functions/interface/updateStatusInformation.html" class="code" title="function updateStatusInformation(fig)">updateStatusInformation</a>(fig);
0598     <span class="comment">% activate animation button</span>
0599     set(gui.push_handles.Animate,<span class="string">'Enable'</span>,<span class="string">'on'</span>);
0600     
0601     <span class="comment">% change the pushbutton color back to green</span>
0602     set(src,<span class="string">'BackGroundColor'</span>,<span class="string">'g'</span>);
0603     
0604 <span class="keyword">else</span>
0605     warndlg({<span class="string">'onPushRun:'</span>,<span class="string">'There is no figure with the BLOCHUS Tag open.'</span>},<span class="keyword">...</span>
0606         <span class="string">'BLOCHUS error'</span>);
0607 <span class="keyword">end</span>
0608 
0609 <span class="keyword">end</span>
0610 
0611 <span class="comment">%------------- END OF CODE --------------</span>
0612 
0613 <span class="comment">%% License:</span>
0614 <span class="comment">% GNU GPLv3</span>
0615 <span class="comment">%</span>
0616 <span class="comment">% BLOCHUS</span>
0617 <span class="comment">% Copyright (C) 2019 Thomas Hiller</span>
0618 <span class="comment">%</span>
0619 <span class="comment">% This program is free software: you can redistribute it and/or modify</span>
0620 <span class="comment">% it under the terms of the GNU General Public License as published by</span>
0621 <span class="comment">% the Free Software Foundation, either version 3 of the License, or</span>
0622 <span class="comment">% (at your option) any later version.</span>
0623 <span class="comment">%</span>
0624 <span class="comment">% This program is distributed in the hope that it will be useful,</span>
0625 <span class="comment">% but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
0626 <span class="comment">% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
0627 <span class="comment">% GNU General Public License for more details.</span>
0628 <span class="comment">%</span>
0629 <span class="comment">% You should have received a copy of the GNU General Public License</span>
0630 <span class="comment">% along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>